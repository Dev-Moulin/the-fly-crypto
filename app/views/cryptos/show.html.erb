<%= javascript_include_tag 'chart' %>
<%= javascript_include_tag 'timechoice' %>
<%= javascript_include_tag 'https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js', defer: true %>
<%= javascript_include_tag 'profanity_filter' %>

<%= render 'shared/navbar' %>

<div class="body-flex">
  <div class="chart-section">
    <!-- Back to Home Button -->
    <%= button_to root_path, class: 'btn-home-go act' do %>
      <%= image_tag 'arrowleft.png', alt: 'arrow-left', class: 'icone' %>
      Back to Home
    <% end %>

    <!-- Card Chart -->
    <div class="card-chart">
      <div class="header-card">
        <div class="info-card">
          <%= image_tag(@crypto.logo_url, alt: 'crypto-logo', class: 'crypto-logo') %>
          <div class="name-symbol">
            <span>
              $<%= @crypto.price.round(2) %>
              <% variation = @crypto.variation_24h %>
              <% if variation >= 0 %>
                <span class="positif">+<%= number_to_human(variation) %>%</span>
              <% else %>
                <span class="negatif"><%= number_to_human(variation) %>%</span>
              <% end %>
            </span>
            <span class="symbol"><%= @crypto.symbol %></span>
          </div>
        </div>

        <!-- Time Choices -->
        <div class="btn-card">
          <div role="button" id="btn-15m" class="choice">
            <p>15m</p>
          </div>
          <div role="button" id="btn-1h" class="choice">
            <p>1h</p>
          </div>
          <div role="button" id="btn-4h" class="choice">
            <p>4h</p>
          </div>
          <div role="button" id="btn-1d-main" class="choice">
            <p id="time-label">1d</p>
              <%= image_tag "arrowbottom.png", alt: "arrow", class: "arrow-bottom" %>
            <div id="time-options">
              <button id="btn-6h">
                <span>6h</span>
              </button>
              <button id="btn-12h">
                <span>12h</span>
              </button>
              <button id="btn-1d">
                <span>1d</span>
              </button>
            </div>
          </div>
        </div>
      </div>

     
      <div id="chart"></div>

      <!-- Vote Section -->
      <div class="vote-section">
        <% if user_signed_in? %>
          <% user_vote = current_user.votes.find_by(crypto: @crypto) %>
          <% if user_vote %>
            <p>
              Your Sentiment Price for <%= user_vote.created_at.utc.strftime('%H:%M UTC %B %d, %Y') %>: 
              <%= user_vote.is_bullished ? 'Bullish' : 'Bearish' %>
            </p>
          <% else %>
            <%= button_to 'Bullish', crypto_votes_path(@crypto, is_bullished: true), method: :post, class: 'btn btn-bullish' %>
            <%= button_to 'Bearish', crypto_votes_path(@crypto, is_bullished: false), method: :post, class: 'btn btn-bearish' %>
          <% end %>
        <% else %>
          <p>Please <%= link_to 'log in', new_user_session_path %> to vote.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Post Section -->
  <div class="post-section">
    <%= render 'shared/flash' %>

    <div class="posts-container">
      <% @posts.each do |post| %>
        <!-- Post -->
        <div class="post-line">
          <p><%= time_ago_in_words(post.created_at) %> ago</p>
          <%= post.user.username %>
          <%= post.content %>
          <%= post.comments.size %>
          <% if post.user == current_user %>
            <%= button_to 'Delete', post_path(post), method: :delete, data: { confirm: 'Are you sure you want to delete this post?' }, class: 'btn-delete-post' %>
          <% end %>
        </div>

        <!-- Comments of the Post -->
        <div class="comments-container">
          <% if post.comments.any? %>
            <% post.comments.order(created_at: :desc).each do |comment| %>
              <div class="comment-line">
                <%= comment.user.username %>
                <%= comment.content %>
                <% if comment.user == current_user %>
                  <%= button_to 'Delete', comment_path(comment), method: :delete, data: { confirm: 'Are you sure you want to delete this comment?' }, class: 'btn-delete-comment' %>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>

        <!-- Form to Add New Comment -->
        <% if user_signed_in? %>
          <div class="new-comment">
            <%= form_with model: [post, Comment.new], local: true do |form| %>
              <%= form.text_field :content, placeholder: 'Your comment...', class: 'form-control' %>
              <%= form.submit 'Create', class: 'btn-primary-add' %>
            <% end %>
          </div>
        <% else %>
          <p>Please <%= link_to 'log in', new_user_session_path %> to add a comment.</p>
        <% end %>
      <% end %>
    </div>

    <!-- Form to Add New Post -->
    <% if user_signed_in? %>
      <div class="new-post">
        <%= form_with model: @post, url: crypto_posts_path(@crypto), local: true do |form| %>
          <%= form.text_field :content, placeholder: 'Write a new post...', class: 'form-control' %>
          <%= form.submit 'Create', class: 'btn-primary-add' %>
        <% end %>
      </div>
    <% else %>
      <p>Please <%= link_to 'log in', new_user_session_path %> to create a post.</p>
    <% end %>
  </div>
</div>
